<html>
  <head>
    <script src='./codemirror/lib/codemirror.js'></script>
    <link href='./style.css' rel='stylesheet'>
    <link href='./codemirror/lib/codemirror.css' rel='stylesheet'>
    <script src="./codemirror/mode/javascript/javascript.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.js"></script>
    <script src="./polar.js"></script>
    <script src="./sketch.js"></script>
    <script src="https://bundle.run/pixelmatch"></script>
  </head>
  <body>
    <div id='container'>
      <div id='codemirror'></div>
      <div id='console'>
        <span>Console</span>
        <hr>
        <div id="msg"></div>
      </div>
      <div id='userDrawing'>
        <div id='draw1' class=''></div>
        <div id='draw2' class=''></div>
        <div id='draw3' class=''></div>
        <div id='draw4' class=''></div>
        <div id='draw5' class=''></div>
        <div id='draw6' class=''></div>
        <div id='draw7' class=''></div>
        <div id='draw8' class=''></div>
        <div id='draw9' class=''></div>
      </div>
      <div id='polarExample'>
        <div id='sketch1' class='col1'></div>
        <div id='sketch2' class='col2'></div>
        <div id='sketch3' class='col3'></div>
        <div id='sketch4' class='col1'></div>
        <div id='sketch5' class='col2'></div>
        <div id='sketch6' class='col3'></div>
        <div id='sketch7' class='row3'></div>
        <div id='sketch8' class='row3'></div>
        <div id='sketch9' class='row3'></div>
      </div>
    </div>
  </body>
  <script>
    window.onload = function() {
      const editor = CodeMirror(document.querySelector('#codemirror'), { 
        value: '/* Welcome to p5.Polar */\n\n'
          + 'const ellipseRadius = 50;\n\n'
          + 'function draw() {\n'
          + '   // type your code here\n'
          + '}',
        mode: 'javascript',
        lineNumbers: true,
        autofocus: true,
        theme: 'tomorrow-night-bright'
      });

      // editor.on('change', function (cm, change) {
      //   var from = change.from;
      //   var text = change.text.join('\n');
      //   var removed = change.removed.join('\n');
      //   var to =  cm.posFromIndex(cm.indexFromPos(from) + text.length);
      //   var before = cm.getRange({ line: 6, ch: 0 }, from);
      //   var after = cm.getRange(to, { line: cm.lineCount() + 1, ch: 0 });
      //   // console.log("after change", before, removed, text, after);
      // });

      editor.setOption('extraKeys', {
        'Shift-Enter': function(cm) {
          try {
            // eval(cm.getValue());
            // let input = eval(cm.getValue()).match(/[^{\}]+(?=})/g)[0].replace(/\s/g, '');
            // let draw1 = function(s) { 
            //   s.setup = function() {
            //     let w = document.getElementById('draw1').clientWidth;
            //     let h = document.getElementById('draw1').clientHeight;
            //     s.createCanvas(w, h);
            //     s.noFill();
            //     s.stroke('#8896a7');
            //     s.strokeWeight(2); 
            //     polar.setCenter(w/2, h/2);
            //   }; 

            //   s.draw = function() {
            //     // if(cm.getValue().match()) {
            //     //   eval('s.'+cm.getValue().match());
            //     // }
            //     s.polarTriangle(0, 80, 80);
            //   }
            // };
            // let userDrawing1 = new p5(draw1, 'draw1');

            var c1 = document.getElementById('defaultCanvas0');
            var c2 = document.getElementById('defaultCanvas1');
            ctx1 = c1.getContext('2d');
            ctx2 = c2.getContext('2d');
            var imageData1 = ctx1.getImageData(0, 0, c1.width, c1.height).data;
            var imageData2 = ctx2.getImageData(0, 0, c2.width, c2.height).data;
            var same = true;
            for (var i = 0; i < imageData1.length; i++) {
              if (imageData1[i] !== imageData2[i]) {
                same = false;
                break;
              }
            }
            console.log(same ? 'same' : 'different');
          }
          catch (error) {
            document.getElementById('msg').innerText = error;
          }
        }
      });
    }
  </script>
</html>